from django.shortcuts import render, redirect
from django.core.mail import send_mail
from django.contrib import messages
from django.urls import reverse
import random
from django.core.cache import cache  # To store the verification code temporarily
from django.contrib.auth.models import User
from django.contrib.auth.hashers import make_password

# Forgot Password view: User enters email to request a password reset
def forgot_password_view(request):
    if request.method == 'POST':
        email = request.POST.get('email')

        # Check if the email exists in the database
        if User.objects.filter(email=email).exists():
            # Generate a 4-digit verification code
            code = str(random.randint(1000, 9999))

            # Store the code in the cache for 10 minutes
            cache.set(email, code, timeout=600)

            # Send the verification code to the user's email
            send_mail(
                'Your Password Reset Code',
                f'Your verification code is {code}',
                'pagepulse.pulse@gmail.com',  # Sender email
                [email],
                fail_silently=False,
            )

            # Redirect to the digitcode page for the user to enter the code
            return redirect(reverse('digitcode'))
        else:
            # If email is not found, show an error message
            messages.error(request, "We couldn't find an account associated with this email address.")
            return render(request, 'forgotpassword.html')

    return render(request, 'forgotpassword.html')


# Digit Code view: User enters the code they received via email
def digitcode_view(request):
    if request.method == 'POST':
        email = request.POST.get('email')
        entered_code = request.POST.get('code')

        # Retrieve the verification code from the cache
        cached_code = cache.get(email)

        # Check if the verification code exists in cache
        if cached_code:
            if cached_code == entered_code:
                # If the code is correct, delete it from cache and redirect to change password
                cache.delete(email)
                return redirect(reverse('changepassword'))
            else:
                # If the code is incorrect, show an error message
                messages.error(request, "Invalid code. Please try again.")
                return render(request, 'digitcode.html')
        else:
            # If the code is not found in cache (expired or invalid), show an error
            messages.error(request, "The verification code has expired or is invalid.")
            return redirect(reverse('forgotpassword'))  # Redirect to forgot password page if code is expired or not found

    return render(request, 'digitcode.html')


# Change Password view: User can change their password after the code is verified
def change_password(request):
    if request.method == 'POST':
        email = request.POST.get('email')
        new_password = request.POST.get('password')

        try:
            # Find the user by email and update the password
            user = User.objects.get(email=email)
            user.password = make_password(new_password)  # Hash the new password
            user.save()

            messages.success(request, "Your password has been successfully updated.")
            return redirect('login')  # Redirect to login page after successful password change
        except User.DoesNotExist:
            messages.error(request, "Error: User not found.")
            return redirect('forgot_password')  # Redirect to the forgot password page if user not found

    return render(request, 'changepassword.html')
